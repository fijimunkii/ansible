input {
	tcp {
    port => 25826
    type => syslog
  }
  udp {
    port => 25826
    type => syslog
  }
}

filter {
  if [type] == "syslog" {
    grok {
      match => { "message" => "docker\/%{DATA:syslog_program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:log}" }
    }
    mutate {
      add_field => {
        "project" => "%{syslog_program}"
        "branch" => "%{syslog_program}"
        "rev" => "%{syslog_program}"
      }
    }
    mutate {
      gsub => [
        "project", "\/.*", "",
        "rev", ".*\/", "",
        "branch", "^[^/]+/", ""
      ]
    }
    mutate {
      gsub => [
        "branch", "\/.*", ""
      ]
    }
    mutate {
      remove_field => [ "message", "syslog_program" ]
    }
  }
}

output {
  amazon_es {
    hosts => ["$ES_HOST"]
    region => "$AWS_REGION"
    aws_access_key_id => '$ACCESS_KEY'
    aws_secret_access_key => '$SECRET_KEY'
    index => "$ENVIRONMENT-logs-%{+YYYY.MM.dd}"
  }
}
